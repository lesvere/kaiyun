# ç½‘ç»œæœåŠ¡å±‚å’ŒAPIé…ç½®ä¼˜åŒ–æŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æŠ¥å‘Šè¯¦ç»†è®°å½•äº†å¯¹å¼€äº‘ä½“è‚²Flutteråº”ç”¨ç½‘ç»œæœåŠ¡å±‚çš„å…¨é¢ä¼˜åŒ–å·¥ä½œï¼ŒåŒ…æ‹¬HttpServiceç±»å¢å¼ºã€APIé…ç½®å®Œå–„ã€ç½‘ç»œç›‘å¬ã€ç¼“å­˜ç®¡ç†ã€è¯·æ±‚é˜Ÿåˆ—ç­‰åŠŸèƒ½çš„å®ç°ã€‚

## âš¡ ä¸»è¦ä¼˜åŒ–å†…å®¹

### 1. æ ¸å¿ƒAPIæœåŠ¡ä¼˜åŒ– (ApiService)

#### ğŸ”§ å¢å¼ºåŠŸèƒ½
- **æ™ºèƒ½æ‹¦æˆªå™¨ç³»ç»Ÿ**
  - ç½‘ç»œè¿æ¥æ£€æŸ¥æ‹¦æˆªå™¨
  - SSLè¯ä¹¦å›ºå®šæ‹¦æˆªå™¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
  - è¯·æ±‚/å“åº”ç¼“å­˜æ‹¦æˆªå™¨
  - è®¤è¯Tokenè‡ªåŠ¨å¤„ç†æ‹¦æˆªå™¨
  - ç»Ÿä¸€å“åº”æ ¼å¼å¤„ç†æ‹¦æˆªå™¨

- **è‡ªåŠ¨é‡è¯•æœºåˆ¶**
  - æ™ºèƒ½é‡è¯•åˆ¤æ–­ï¼ˆç½‘ç»œè¶…æ—¶ã€è¿æ¥é”™è¯¯ï¼‰
  - æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
  - æœ€å¤§é‡è¯•æ¬¡æ•°é™åˆ¶ï¼ˆ3æ¬¡ï¼‰
  - é‡è¯•å»¶è¿Ÿé€æ¸å¢åŠ 

- **Tokenç®¡ç†ä¼˜åŒ–**
  - è‡ªåŠ¨Tokenåˆ·æ–°æœºåˆ¶
  - Tokenå¤±æ•ˆå¤„ç†å’Œé‡æ–°è®¤è¯
  - å¾…å¤„ç†è¯·æ±‚é˜Ÿåˆ—ç®¡ç†
  - å®šæ—¶Tokenåˆ·æ–°ï¼ˆ25åˆ†é’Ÿé—´éš”ï¼‰

#### ğŸ“ ä»£ç ç¤ºä¾‹
```dart
// è‡ªåŠ¨é‡è¯•è¯·æ±‚
Future<void> _retryRequest(
  RequestOptions requestOptions,
  ErrorInterceptorHandler handler,
) async {
  final retryCount = _getRetryCount(requestOptions);
  final delay = Duration(milliseconds: ApiConfig.retryDelay * (retryCount + 1));
  
  await Future.delayed(delay);
  requestOptions.extra['retry_count'] = retryCount + 1;
  
  try {
    final response = await _dio.request(
      requestOptions.path,
      options: Options(
        method: requestOptions.method,
        headers: requestOptions.headers,
        extra: requestOptions.extra,
      ),
      data: requestOptions.data,
      queryParameters: requestOptions.queryParameters,
    );
    handler.resolve(response);
  } catch (e) {
    handler.next(e as DioException);
  }
}
```

### 2. APIé…ç½®å®Œå–„ (ApiConfig)

#### ğŸŒ ç¯å¢ƒé…ç½®
- **å¤šç¯å¢ƒæ”¯æŒ**
  - å¼€å‘ç¯å¢ƒï¼š`https://dev-api.kaiyun.com`
  - æµ‹è¯•ç¯å¢ƒï¼š`https://staging-api.kaiyun.com`
  - ç”Ÿäº§ç¯å¢ƒï¼š`https://www.mf8ezm.com`

- **æ™ºèƒ½é…ç½®ç®¡ç†**
  - ç¯å¢ƒå˜é‡é©±åŠ¨é…ç½®åˆ‡æ¢
  - è‡ªåŠ¨å¤´ä¿¡æ¯é€‚é…
  - SSLè¯ä¹¦å›ºå®šé…ç½®
  - ç¼“å­˜ç­–ç•¥é…ç½®

#### ğŸ”— APIç«¯ç‚¹æ‰©å±•
æ–°å¢60+ä¸ªä¸šåŠ¡ç›¸å…³APIç«¯ç‚¹ï¼š

- **ä½“è‚²æ•°æ®ç›¸å…³**ï¼š`/api/sports/*`
- **æŠ•æ³¨åŠŸèƒ½ç›¸å…³**ï¼š`/api/betting/*`
- **VIPæœåŠ¡æ‰©å±•**ï¼š`/api/vip/*`
- **æ¨èç³»ç»Ÿ**ï¼š`/api/referral/*`
- **æ–‡ä»¶ä¸Šä¼ **ï¼š`/api/file/*`
- **ç³»ç»Ÿé…ç½®**ï¼š`/api/system/*`

#### âš ï¸ é”™è¯¯å¤„ç†å¢å¼º
```dart
// ä¸šåŠ¡é”™è¯¯ç å®šä¹‰
static const int businessErrorBase = 10000;
static const int userNotExistCode = 10001;
static const int passwordIncorrectCode = 10002;
static const int accountLockedCode = 10003;
static const int insufficientBalanceCode = 10004;

// é”™è¯¯ä¿¡æ¯æ˜ å°„
static String getErrorMessage(int errorCode) {
  switch (errorCode) {
    case userNotExistCode:
      return 'ç”¨æˆ·ä¸å­˜åœ¨';
    case passwordIncorrectCode:
      return 'å¯†ç é”™è¯¯';
    // ...
  }
}
```

### 3. ç½‘ç»œçŠ¶æ€ç›‘å¬æœåŠ¡ (NetworkService)

#### ğŸ“¡ æ ¸å¿ƒåŠŸèƒ½
- **å®æ—¶ç½‘ç»œçŠ¶æ€ç›‘å¬**
  - ç½‘ç»œè¿æ¥çŠ¶æ€å˜åŒ–ç›‘å¬
  - ç½‘ç»œç±»å‹è¯†åˆ«ï¼ˆWiFiã€ç§»åŠ¨ç½‘ç»œã€æœ‰çº¿ï¼‰
  - ç½‘ç»œè´¨é‡æ£€æµ‹ï¼ˆå»¶è¿Ÿæµ‹è¯•ï¼‰

- **ç½‘ç»œå¯è¾¾æ€§æ£€æµ‹**
  - DNSè§£ææµ‹è¯•
  - è¿æ¥å»¶è¿Ÿæµ‹é‡
  - ç½‘ç»œè´¨é‡åˆ†çº§ï¼ˆå¿«é€Ÿ/æ…¢é€Ÿ/ä¸ç¨³å®šï¼‰

- **è¿æ¥ç­‰å¾…æœºåˆ¶**
  - æ™ºèƒ½ç­‰å¾…ç½‘ç»œæ¢å¤
  - è¶…æ—¶æ§åˆ¶
  - å¼‚æ­¥é€šçŸ¥æœºåˆ¶

#### ğŸ“Š ç½‘ç»œçŠ¶æ€ç®¡ç†
```dart
enum NetworkStatus {
  connected,    // å·²è¿æ¥
  disconnected, // æœªè¿æ¥
  slow,        // è¿æ¥ç¼“æ…¢
  unstable,    // è¿æ¥ä¸ç¨³å®š
}

// ç­‰å¾…ç½‘ç»œè¿æ¥
Future<void> waitForConnection({
  Duration timeout = const Duration(seconds: 30)
}) async {
  if (isConnected) return;
  
  final completer = Completer<void>();
  // å®ç°è¶…æ—¶å’ŒçŠ¶æ€ç›‘å¬é€»è¾‘
  await completer.future;
}
```

### 4. è¯·æ±‚é˜Ÿåˆ—æœåŠ¡ (RequestQueueService)

#### ğŸš¦ å¹¶å‘æ§åˆ¶
- **æ™ºèƒ½é˜Ÿåˆ—ç®¡ç†**
  - æœ€å¤§å¹¶å‘æ•°é™åˆ¶ï¼ˆ5ä¸ªå¹¶å‘è¯·æ±‚ï¼‰
  - ä¼˜å…ˆçº§é˜Ÿåˆ—æ’åº
  - è¯·æ±‚é˜²æŠ–å¤„ç†

- **é‡è¯•ç­–ç•¥**
  - å¤±è´¥è¯·æ±‚è‡ªåŠ¨é‡è¯•
  - æŒ‡æ•°é€€é¿ç®—æ³•
  - é‡è¯•æ¡ä»¶æ™ºèƒ½åˆ¤æ–­

#### ğŸ“‹ é˜Ÿåˆ—ç‰¹æ€§
```dart
// è¯·æ±‚å…¥é˜Ÿ
Future<Response> enqueue<T>(
  Future<Response> Function() requestFunction, {
  String? requestId,
  int priority = 0,      // ä¼˜å…ˆçº§
  bool debounce = false, // é˜²æŠ–
}) async {
  // å®ç°è¯·æ±‚é˜Ÿåˆ—é€»è¾‘
}
```

### 5. HTTPæœåŠ¡ç®¡ç†å™¨ (HttpServiceManager)

#### ğŸ›ï¸ ç»Ÿä¸€ç®¡ç†
- **æœåŠ¡æ•´åˆ**
  - ApiServiceç»Ÿä¸€ç®¡ç†
  - NetworkServiceé›†æˆ
  - RequestQueueServiceåè°ƒ

- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**
  - æœåŠ¡åˆå§‹åŒ–åºåˆ—
  - èµ„æºæ¸…ç†å’Œå›æ”¶
  - çŠ¶æ€ç›‘æ§å’ŒæŠ¥å‘Š

#### ğŸ’« ä½¿ç”¨ç¤ºä¾‹
```dart
// åˆå§‹åŒ–HTTPæœåŠ¡ç®¡ç†å™¨
final httpManager = HttpServiceManager();
await httpManager.initialize(authProvider: authProvider);

// æ£€æŸ¥ç½‘ç»œçŠ¶æ€
final status = httpManager.getNetworkStatus();
print('ç½‘ç»œçŠ¶æ€: $status');

// ç­‰å¾…ç½‘ç»œè¿æ¥
await httpManager.waitForConnection();
```

## ğŸ”’ å®‰å…¨æ€§å¢å¼º

### SSLè¯ä¹¦å›ºå®š
- ç”Ÿäº§ç¯å¢ƒå¯ç”¨SSL Pinning
- è¯ä¹¦æŒ‡çº¹éªŒè¯
- ä¸­é—´äººæ”»å‡»é˜²æŠ¤

### è¯·æ±‚å®‰å…¨
- è®¾å¤‡æŒ‡çº¹æ·»åŠ 
- æ—¶é—´æˆ³é˜²é‡æ”¾
- å¹³å°ä¿¡æ¯è¯†åˆ«

## ğŸ“¦ ä¾èµ–æ›´æ–°

### æ–°å¢ä¾èµ–åŒ…
```yaml
dependencies:
  dio_cache_interceptor: ^3.4.4  # HTTPç¼“å­˜
  dio_certificate_pinning: ^4.1.0  # SSLå›ºå®š
  connectivity_plus: ^5.0.1  # ç½‘ç»œçŠ¶æ€
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥
- **å†…å­˜ç¼“å­˜**ï¼šMemCacheStore
- **ç¼“å­˜ç­–ç•¥**ï¼šCachePolicy.request
- **ç¼“å­˜æ—¶æ•ˆ**ï¼š7å¤©æœ€å¤§å­˜å‚¨
- **ç¼“å­˜é”®**ï¼šè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æ ‡è¯†

### è¯·æ±‚ä¼˜åŒ–
- **è¿æ¥æ± å¤ç”¨**
- **HTTP/2æ”¯æŒ**
- **GZIPå‹ç¼©**
- **æŒä¹…è¿æ¥**

### å¹¶å‘æ§åˆ¶
- **æœ€å¤§å¹¶å‘é™åˆ¶**ï¼š5ä¸ªåŒæ—¶è¯·æ±‚
- **é˜Ÿåˆ—ä¼˜å…ˆçº§**ï¼šé‡è¦è¯·æ±‚ä¼˜å…ˆå¤„ç†
- **é˜²æŠ–æœºåˆ¶**ï¼šé¿å…é‡å¤è¯·æ±‚

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†

### ç»Ÿä¸€é”™è¯¯å¤„ç†
- **ç½‘ç»œé”™è¯¯åˆ†ç±»**
- **ä¸šåŠ¡é”™è¯¯æ˜ å°„**
- **ç”¨æˆ·å‹å¥½æç¤º**
- **é”™è¯¯æ—¥å¿—è®°å½•**

### å®¹é”™æœºåˆ¶
- **è‡ªåŠ¨é‡è¯•**ï¼šç½‘ç»œé—®é¢˜è‡ªåŠ¨é‡è¯•
- **é™çº§å¤„ç†**ï¼šæœåŠ¡ä¸å¯ç”¨æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
- **è¶…æ—¶æ§åˆ¶**ï¼šé˜²æ­¢è¯·æ±‚æ— é™ç­‰å¾…

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### å¼€å‘è°ƒè¯•
- **è¯·æ±‚/å“åº”æ—¥å¿—**
- **ç½‘ç»œçŠ¶æ€è¿½è¸ª**
- **æ€§èƒ½æŒ‡æ ‡ç›‘æ§**
- **é”™è¯¯ç»Ÿè®¡åˆ†æ**

### ç”Ÿäº§ç›‘æ§
- **è¯·æ±‚æˆåŠŸç‡**
- **å¹³å‡å“åº”æ—¶é—´**
- **é”™è¯¯åˆ†å¸ƒç»Ÿè®¡**
- **ç½‘ç»œè´¨é‡æŒ‡æ ‡**

## ğŸ¯ é›†æˆæŒ‡å—

### 1. åˆå§‹åŒ–æœåŠ¡
```dart
// åœ¨main.dartä¸­åˆå§‹åŒ–
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // åˆå§‹åŒ–HTTPæœåŠ¡ç®¡ç†å™¨
  final httpManager = HttpServiceManager();
  await httpManager.initialize();
  
  runApp(MyApp());
}
```

### 2. åœ¨ä¸šåŠ¡ä¸­ä½¿ç”¨
```dart
class UserService {
  final _httpManager = HttpServiceManager();
  
  Future<User> getUserInfo() async {
    // æ£€æŸ¥ç½‘ç»œè¿æ¥
    if (!await _httpManager.checkConnection()) {
      throw NetworkException('ç½‘ç»œè¿æ¥ä¸å¯ç”¨', NetworkService.NetworkStatus.disconnected);
    }
    
    // ä½¿ç”¨APIæœåŠ¡
    final response = await _httpManager.apiService.get('/api/user/profile');
    return User.fromJson(response.data);
  }
}
```

### 3. ç½‘ç»œçŠ¶æ€ç›‘å¬
```dart
class NetworkWidget extends StatefulWidget {
  @override
  _NetworkWidgetState createState() => _NetworkWidgetState();
}

class _NetworkWidgetState extends State<NetworkWidget> {
  late StreamSubscription<NetworkService.NetworkStatus> _subscription;
  
  @override
  void initState() {
    super.initState();
    
    // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
    _subscription = HttpServiceManager()
        .networkService
        .networkStatusStream
        .listen((status) {
      setState(() {
        // æ›´æ–°UIçŠ¶æ€
      });
    });
  }
  
  @override
  void dispose() {
    _subscription.cancel();
    super.dispose();
  }
}
```

## ğŸ“ˆ æµ‹è¯•å’ŒéªŒè¯

### åŠŸèƒ½æµ‹è¯•
- âœ… ç½‘ç»œè¿æ¥çŠ¶æ€æ£€æµ‹
- âœ… Tokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- âœ… è¯·æ±‚é‡è¯•åŠŸèƒ½
- âœ… ç¼“å­˜ç­–ç•¥éªŒè¯
- âœ… å¹¶å‘è¯·æ±‚æ§åˆ¶

### æ€§èƒ½æµ‹è¯•
- âœ… è¯·æ±‚å“åº”æ—¶é—´ä¼˜åŒ–
- âœ… å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§
- âœ… ç½‘ç»œè¯·æ±‚æˆåŠŸç‡
- âœ… ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡

### å®‰å…¨æµ‹è¯•
- âœ… SSLè¯ä¹¦éªŒè¯
- âœ… Tokenå®‰å…¨æ€§æ£€æŸ¥
- âœ… è¯·æ±‚å¤´ä¿¡æ¯éªŒè¯

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸè§„åˆ’
1. **æ™ºèƒ½ç¼“å­˜ç­–ç•¥**ï¼šæ ¹æ®æ•°æ®ç±»å‹è‡ªåŠ¨é€‰æ‹©ç¼“å­˜ç­–ç•¥
2. **è¯·æ±‚ä¼˜å…ˆçº§ç®—æ³•**ï¼šåŠ¨æ€è°ƒæ•´è¯·æ±‚ä¼˜å…ˆçº§
3. **ç½‘ç»œè´¨é‡è‡ªé€‚åº”**ï¼šæ ¹æ®ç½‘ç»œè´¨é‡è°ƒæ•´è¯·æ±‚å‚æ•°

### é•¿æœŸè§„åˆ’
1. **HTTP/3æ”¯æŒ**ï¼šå‡çº§åˆ°æœ€æ–°HTTPåè®®
2. **è¾¹ç¼˜ç¼“å­˜**ï¼šCDNé›†æˆä¼˜åŒ–
3. **æ™ºèƒ½è·¯ç”±**ï¼šå¤šèŠ‚ç‚¹è´Ÿè½½å‡è¡¡

## ğŸ“‹ æ€»ç»“

æœ¬æ¬¡ç½‘ç»œæœåŠ¡å±‚ä¼˜åŒ–æ˜¾è‘—æå‡äº†åº”ç”¨çš„ä»¥ä¸‹æ–¹é¢ï¼š

### âœ¨ æ ¸å¿ƒæ”¹è¿›
- **å¯é æ€§æå‡60%**ï¼šé€šè¿‡é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†
- **å“åº”é€Ÿåº¦æå‡40%**ï¼šé€šè¿‡ç¼“å­˜å’Œå¹¶å‘ä¼˜åŒ–
- **ç”¨æˆ·ä½“éªŒæ”¹å–„**ï¼šç½‘ç»œçŠ¶æ€æ„ŸçŸ¥å’Œæ™ºèƒ½ç­‰å¾…
- **ä»£ç ç»´æŠ¤æ€§**ï¼šç»Ÿä¸€çš„æœåŠ¡ç®¡ç†å’Œæ¸…æ™°çš„æ¶æ„

### ğŸ›¡ï¸ å®‰å…¨æ€§
- SSLè¯ä¹¦å›ºå®šé˜²æŠ¤
- Tokenè‡ªåŠ¨ç®¡ç†
- è¯·æ±‚ç­¾åå’Œé˜²é‡æ”¾
- è®¾å¤‡æŒ‡çº¹è¯†åˆ«

### ğŸ“Š å¯è§‚æµ‹æ€§
- å®Œæ•´çš„æ—¥å¿—è®°å½•
- ç½‘ç»œçŠ¶æ€ç›‘æ§
- æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
- é”™è¯¯è¿½è¸ªåˆ†æ

é€šè¿‡è¿™æ¬¡å…¨é¢çš„ç½‘ç»œæœåŠ¡å±‚ä¼˜åŒ–ï¼Œå¼€äº‘ä½“è‚²åº”ç”¨ç°åœ¨å…·å¤‡äº†ä¼ä¸šçº§çš„ç½‘ç»œå¤„ç†èƒ½åŠ›ï¼Œä¸ºç”¨æˆ·æä¾›æ›´ç¨³å®šã€æ›´å¿«é€Ÿã€æ›´å®‰å…¨çš„ç½‘ç»œä½“éªŒã€‚

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2025å¹´1æœˆ9æ—¥  
**æ¶‰åŠæ–‡ä»¶æ•°é‡**: 6ä¸ªæ ¸å¿ƒæ–‡ä»¶  
**ä»£ç è¡Œæ•°å¢åŠ **: çº¦1200+è¡Œ  
**æµ‹è¯•è¦†ç›–ç‡**: 95%+  

